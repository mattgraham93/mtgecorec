<!doctype html>
<html>
  <head>
    <title>Card Database - MTGECOREC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-purple.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  </head>
  <body>
    {% include 'nav.html' %}
  <main style="margin-top:4.8rem;">
      <div class="container my-4">
        <h2 class="mb-3">Card Database</h2>
        <div id="active-filters-cards" class="mb-3" style="font-size: 1.1rem; color: #F3F0FF;"></div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div></div>
          <button id="clear-filters-btn" class="btn btn-secondary" style="font-weight:600;border-radius:2rem;padding:0.4rem 1.2rem;">
            <span style="font-size:1.1em;">&#x21bb;</span> Clear Filters
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="cards-table">
            <thead class="table-dark">
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Set</th>
                <th>Rarity</th>
                <th>Price</th>
                <th>Image</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be inserted here -->
            </tbody>
          </table>
        </div>
        <nav>
          <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be inserted here -->
          </ul>
        </nav>
      </div>
    </main>
    <script>
    const PAGE_SIZE = 25;
    let cards = [];
    let currentPage = 1;
    let totalCards = 0;

    function updateActiveFiltersDisplay() {
      const savedFilters = localStorage.getItem('mtgCardFilters');
      let filterText = '';
      let hasFilters = false;
      if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        if (filters.color) {
          filterText += `<span class="badge bg-primary me-2">${filters.color}</span>`;
          hasFilters = true;
        }
        if (filters.type) {
          filterText += `<span class="badge bg-secondary">${filters.type}</span>`;
          hasFilters = true;
        }
      }
      document.getElementById('active-filters-cards').innerHTML = filterText || '<span class="text-muted">No active filters</span>';
      
      // Show/hide clear filters button
      const clearBtn = document.getElementById('clear-filters-btn');
      if (clearBtn) {
        clearBtn.style.display = hasFilters ? 'block' : 'none';
      }
    }

    async function fetchCards(page = 1) {
      try {
        // Get filters from localStorage
        const savedFilters = localStorage.getItem('mtgCardFilters');
        let filters = {};
        if (savedFilters) {
          filters = JSON.parse(savedFilters);
        }
        
        // Build query string with filters
        let queryParams = `page=${page}&page_size=${PAGE_SIZE}`;
        if (filters.color) {
          queryParams += `&color=${encodeURIComponent(filters.color)}`;
        }
        if (filters.type) {
          queryParams += `&type=${encodeURIComponent(filters.type)}`;
        }
        
        const res = await fetch(`/api/cards?${queryParams}`);
        const data = await res.json();
        console.log('Fetched card data:', data);
        cards = data.cards;
        totalCards = data.total;
        currentPage = data.page;
        renderTable();
        renderPagination();
        updateActiveFiltersDisplay();
      } catch (err) {
        console.error('Failed to fetch cards:', err);
      }
    }

    function renderTable() {
      const tbody = document.querySelector('#cards-table tbody');
      if (!tbody) {
        console.error('Table body element #cards-table tbody not found!');
        return;
      }
      tbody.innerHTML = '';
      for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${card.name || ''}</td>
          <td>${card.type_line ? card.type_line.split(' — ')[0] : ''}</td>
          <td>${card.set || ''}</td>
          <td>${card.rarity || ''}</td>
          <td>${card.price !== undefined ? '$' + card.price.toLocaleString() : ''}</td>
          <td>${card.image_uris && card.image_uris.normal ? `<img src="${card.image_uris.normal}" alt="${card.name}" style="max-width:60px;max-height:80px;cursor:pointer;" onclick="showCardModal(${i})">` : ''}</td>
        </tr>`;
        tbody.appendChild(row);
      }
    }

    function renderPagination() {
      const pageCount = Math.max(1, Math.ceil(totalCards / PAGE_SIZE));
      const pagination = document.getElementById('pagination');
      if (!pagination) {
        console.error('Pagination element #pagination not found!');
        return;
      }
      pagination.innerHTML = '';

      // Left arrow
      const liPrev = document.createElement('li');
      liPrev.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      const aPrev = document.createElement('a');
      aPrev.className = 'page-link';
      aPrev.href = '#';
      aPrev.innerHTML = '&laquo;';
      aPrev.onclick = (e) => {
        e.preventDefault();
        if (currentPage > 1) fetchCards(currentPage - 1);
      };
      liPrev.appendChild(aPrev);
      pagination.appendChild(liPrev);

      // Page input
      const liInput = document.createElement('li');
      liInput.className = 'page-item';
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 1;
      input.max = pageCount;
      input.value = currentPage;
      input.style = 'width: 60px; text-align: center; display: inline-block;';
      input.className = 'form-control';
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          let val = parseInt(input.value);
          if (!isNaN(val) && val >= 1 && val <= pageCount) {
            fetchCards(val);
          } else {
            input.value = currentPage;
          }
        }
      };
      input.onblur = () => {
        let val = parseInt(input.value);
        if (!isNaN(val) && val >= 1 && val <= pageCount && val !== currentPage) {
          fetchCards(val);
        } else {
          input.value = currentPage;
        }
      };
      liInput.appendChild(input);
      pagination.appendChild(liInput);

      // Total pages display
      const liTotal = document.createElement('li');
      liTotal.className = 'page-item disabled';
      const spanTotal = document.createElement('span');
      spanTotal.className = 'page-link';
      spanTotal.style = 'background: none; border: none; color: #333;';
      spanTotal.textContent = ` / ${pageCount}`;
      liTotal.appendChild(spanTotal);
      pagination.appendChild(liTotal);

      // Right arrow
      const liNext = document.createElement('li');
      liNext.className = 'page-item' + (currentPage === pageCount ? ' disabled' : '');
      const aNext = document.createElement('a');
      aNext.className = 'page-link';
      aNext.href = '#';
      aNext.innerHTML = '&raquo;';
      aNext.onclick = (e) => {
        e.preventDefault();
        if (currentPage < pageCount) fetchCards(currentPage + 1);
      };
      liNext.appendChild(aNext);
      pagination.appendChild(liNext);
    }

    window.onload = () => {
      updateActiveFiltersDisplay();
      fetchCards(1);
      // Listen for localStorage changes (when filters are updated from visualizations page)
      window.addEventListener('storage', (e) => {
        if (e.key === 'mtgCardFilters') {
          fetchCards(1); // Reload first page with new filters
        }
      });
      
      // Clear filters button
      const clearBtn = document.getElementById('clear-filters-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          localStorage.removeItem('mtgCardFilters');
          fetchCards(1);
        });
      }
    };
    </script>

    <!-- Modal for card image popout -->
    <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cardModalLabel">Card Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img id="modalCardImage" src="" alt="Card Image" style="max-width:100%;max-height:60vh;">
            <div class="mt-3" id="modalCardCaption"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showCardModal(cardIndex) {
        const card = cards[cardIndex];
        document.getElementById('modalCardImage').src = card.image_uris ? card.image_uris.normal : '';
        document.getElementById('modalCardImage').alt = card.name;
        // Compose caption with core info
        document.getElementById('modalCardCaption').innerHTML = `
          <strong>${card.name || ''}</strong><br>
          <span>${card.type_line ? card.type_line.split(' — ')[0] : ''}</span><br>
          <span>Set: ${card.set || ''}</span><br>
          <span>Rarity: ${card.rarity || ''}</span><br>
          <span>Price: ${card.price !== undefined ? '$' + card.price.toLocaleString() : ''}</span>
        `;
        var modal = new bootstrap.Modal(document.getElementById('cardModal'));
        modal.show();
      }
    </script>
  </body>
</html>
