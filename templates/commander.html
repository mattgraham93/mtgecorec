<!doctype html>
<head>
    <title>Commander Deck Builder - MTG EcoRec</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-purple.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        .commander-search {
            background: rgba(185, 131, 255, 0.05);
            border: 2px solid rgba(185, 131, 255, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .commander-card {
            background: rgba(185, 131, 255, 0.1);
            border: 1px solid rgba(185, 131, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .commander-card:hover {
            background: rgba(185, 131, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .commander-card.selected {
            background: rgba(185, 131, 255, 0.3);
            border-color: #B983FF;
        }
        
        .color-identity {
            display: inline-flex;
            gap: 4px;
            margin-left: 10px;
        }
        
        .mana-symbol {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
        }
        
        .mana-W { background: #FFFBD5; color: #000; }
        .mana-U { background: #0E68AB; }
        .mana-B { background: #150B00; }
        .mana-R { background: #D3202A; }
        .mana-G { background: #00733E; }
        
        .recommendation-card {
            background: rgba(45, 27, 74, 0.8);
            border: 1px solid rgba(185, 131, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }
        
        .recommendation-card:hover {
            background: rgba(45, 27, 74, 1);
            border-color: rgba(185, 131, 255, 0.5);
        }
        
        .confidence-bar {
            height: 4px;
            background: rgba(185, 131, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #B983FF, #9D4EDD);
            transition: width 0.3s ease;
        }
        
        .category-badge {
            background: rgba(185, 131, 255, 0.2);
            color: #B983FF;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 8px;
        }
        
        .versions-badge {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        
        .card-image-small img {
            transition: transform 0.2s ease;
        }
        
        .recommendation-card[onclick]:hover {
            cursor: pointer;
            background: rgba(45, 27, 74, 1);
            border-color: rgba(185, 131, 255, 0.7);
        }
        
        .recommendation-card[onclick]:hover .card-image-small img {
            transform: scale(1.05);
        }
        
        .modal .card:hover {
            transform: translateY(-5px);
            border-color: rgba(185, 131, 255, 0.5);
            box-shadow: 0 8px 16px rgba(185, 131, 255, 0.2);
        }
        
        .modal .card img {
            transition: transform 0.2s ease;
        }
        
        .modal .card:hover img {
            transform: scale(1.02);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(185, 131, 255, 0.3);
            border-radius: 50%;
            border-top-color: #B983FF;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .ai-analysis {
            background: rgba(0, 100, 0, 0.1);
            border: 1px solid rgba(0, 200, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .filters {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* AI Enhancement Animations */
        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.6; transform: scale(1); }
        }
        
        @keyframes aiGlow {
            0% { box-shadow: 0 0 5px rgba(78, 205, 196, 0.3); }
            50% { box-shadow: 0 0 15px rgba(78, 205, 196, 0.6), 0 0 25px rgba(78, 205, 196, 0.4); }
            100% { box-shadow: 0 0 5px rgba(78, 205, 196, 0.3); }
        }
        
        .recommendation-card {
            transition: all 0.3s ease;
        }
        
        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(185, 131, 255, 0.15);
        }
        
        /* Equal height columns */
        .equal-height-row {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
        }
        
        .equal-height-col {
            display: flex;
            flex-direction: column;
        }
        
        .commander-search,
        .filters {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        
        /* Printing item styles */
        .printing-item {
            background: rgba(185, 131, 255, 0.1);
            border: 1px solid rgba(185, 131, 255, 0.2);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .printing-item:hover {
            background: rgba(185, 131, 255, 0.2);
            border-color: rgba(185, 131, 255, 0.4);
        }
        
        .printing-item.active {
            background: rgba(185, 131, 255, 0.3);
            border-color: #B983FF;
        }
        
        .printing-info {
            flex: 1;
        }
        
        .printing-set {
            color: #F3F0FF;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .printing-details {
            color: #888;
            font-size: 0.8rem;
        }
        
        .printing-price {
            color: #B983FF;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<html>
<body>
    {% include 'nav.html' %}
    
    <main style="margin-top: 4.8rem;">
        <div class="container-fluid">
            <!-- Top Selection Row -->
            <div class="row mb-4 equal-height-row">
                <!-- Commander Selection Panel -->
                <div class="col-md-6 equal-height-col">
                    <div class="commander-search">
                        <h3 class="text-center mb-3" style="color: #B983FF;">Choose Your Commander</h3>
                        
                        <div class="mb-3">
                            <input type="text" 
                                   id="commander-search-input" 
                                   class="form-control" 
                                   placeholder="Search for a commander..."
                                   style="background: rgba(0,0,0,0.3); border-color: rgba(185,131,255,0.5); color: #F3F0FF;">
                        </div>
                        
                        <div id="commander-results" style="max-height: 300px; overflow-y: auto;">
                            <!-- Commander search results will appear here -->
                        </div>
                        
                        <div id="selected-commander" style="display: none;">
                            <h5 style="color: #B983FF;">Selected Commander:</h5>
                            <div id="commander-display"></div>
                            
                            <!-- Commander Card Image and Printings Side-by-Side -->
                            <div id="commander-image-section" class="mt-3">
                                <div class="row">
                                    <!-- Printings List (Left) -->
                                    <div class="col-md-5">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small style="color: #B983FF; font-weight: bold;">Available Printings:</small>
                                            <small id="printings-count" style="color: #888;"></small>
                                        </div>
                                        <div id="commander-printings" 
                                             style="height: 350px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                                            <!-- Printings will be loaded here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Commander Image (Right) -->
                                    <div class="col-md-7">
                                        <div class="text-center" style="height: 350px; display: flex; align-items: center; justify-content: center;">
                                            <div>
                                                <img id="commander-image" 
                                                     class="img-fluid" 
                                                     style="max-width: 250px; max-height: 330px; border-radius: 12px; border: 2px solid rgba(185,131,255,0.3); display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"
                                                     alt="Commander card"
                                                     onerror="this.style.display='none'; document.getElementById('commander-image-loading').innerHTML='Image unavailable';">
                                                <div id="commander-image-loading" style="display: none; color: #888;">
                                                    Loading image...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Filters -->
                <div class="col-md-6 equal-height-col">
                    <div class="filters" id="recommendation-filters" style="display: none;">
                        <h3 class="text-center mb-3" style="color: #B983FF;">Preferences</h3>
                        
                        <div class="mb-3">
                            <label class="form-label" style="color: #F3F0FF;">Budget per Card</label>
                            <select id="budget-select" class="form-control" style="background: rgba(0,0,0,0.3); border-color: rgba(185,131,255,0.5); color: #F3F0FF;">
                                <option value="">No budget limit</option>
                                <option value="1">Under $1</option>
                                <option value="5">Under $5</option>
                                <option value="10">Under $10</option>
                                <option value="25">Under $25</option>
                                <option value="50">Under $50</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" style="color: #F3F0FF;">Power Level</label>
                            <select id="power-select" class="form-control" style="background: rgba(0,0,0,0.3); border-color: rgba(185,131,255,0.5); color: #F3F0FF;">
                                <option value="casual">Casual</option>
                                <option value="focused">Focused</option>
                                <option value="optimized">Optimized</option>
                                <option value="competitive">Competitive</option>
                            </select>
                        </div>

                        <!-- Mechanic/Theme Preferences -->
                        <div class="mb-3">
                            <label class="form-label" style="color: #F3F0FF;">Preferred Mechanics/Themes</label>
                            <div class="mb-2">
                                <textarea id="preferred-mechanics" 
                                          class="form-control" 
                                          rows="2"
                                          placeholder="E.g., 'Flying creatures and artifacts', 'Graveyard recursion', 'Token generation'"
                                          style="background: rgba(0,0,0,0.3); border-color: rgba(185,131,255,0.5); color: #F3F0FF; resize: vertical;"></textarea>
                                <small style="color: #888; font-size: 0.8rem;">
                                    Describe strategies you enjoy - guides AI card research.
                                </small>
                            </div>
                            
                            <!-- Quick Theme Buttons -->
                            <div class="mb-2">
                                <small style="color: #B983FF; display: block; margin-bottom: 8px;">Quick Select:</small>
                                <div class="d-flex flex-wrap gap-1">
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Flying and artifacts')" 
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Flying + Artifacts
                                    </button>
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Token generation')"
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Tokens
                                    </button>
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Graveyard value')"
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Graveyard
                                    </button>
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Spellslinger')"
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Spells
                                    </button>
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Counters and proliferate')"
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Counters
                                    </button>
                                    <button type="button" class="btn btn-sm theme-btn" onclick="addTheme('Tribal synergies')"
                                            style="background: rgba(185,131,255,0.2); border-color: rgba(185,131,255,0.5); color: #B983FF; font-size: 0.75rem;">
                                        Tribal
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button id="get-recommendations-btn" class="btn btn-primary w-100" 
                                style="background: #2D1B4A; border-color: #B983FF;">
                            Get AI-Powered Recommendations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recommendations Row -->
            <div class="row">
                <!-- Full width recommendations panel -->
                <div class="col-12">

                    <div id="recommendations-panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 style="color: #B983FF; margin: 0;">Deck Recommendations</h3>
                            <div class="export-buttons">
                                <button id="export-scryfall-btn" class="btn btn-sm me-2" 
                                        style="background: rgba(185,131,255,0.2); border-color: #B983FF; color: #B983FF;"
                                        onclick="exportToScryfall()">
                                    Export to Scryfall
                                </button>
                                <button id="export-text-btn" class="btn btn-sm" 
                                        style="background: rgba(185,131,255,0.2); border-color: #B983FF; color: #B983FF;"
                                        onclick="exportToText()">
                                    Export List
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI Analysis Section -->
                        <div id="ai-analysis-section" style="display: none;">
                            <div class="ai-analysis">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 style="color: #00FF00; margin: 0;">AI Strategic Analysis</h5>
                                    <button id="generate-summary-btn" class="btn btn-sm" 
                                            style="background: rgba(0, 255, 0, 0.2); border-color: #00FF00; color: #00FF00;"
                                            onclick="generateAnalysisSummary()">
                                        Generate Executive Summary
                                    </button>
                                </div>
                                
                                <!-- Analysis Summary Section -->
                                <div id="analysis-summary" style="display: none; margin-bottom: 20px;">
                                    <div style="background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 8px; padding: 15px;">
                                        <h6 style="color: #00FF00; margin-bottom: 10px;">Executive Summary</h6>
                                        <div id="analysis-summary-content" style="color: #F3F0FF;">
                                            <div class="loading-spinner"></div> Generating summary...
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Detailed Analysis -->
                                <div id="ai-analysis-content">
                                    <div class="loading-spinner"></div> Loading AI analysis...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deck Summary -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card" style="background: rgba(45, 27, 74, 0.6); border-color: rgba(185, 131, 255, 0.3);">
                                    <div class="card-body">
                                        <h6 class="card-title" style="color: #B983FF;">Deck Strategy</h6>
                                        <p class="card-text" id="deck-strategy" style="color: #F3F0FF;">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="background: rgba(45, 27, 74, 0.6); border-color: rgba(185, 131, 255, 0.3);">
                                    <div class="card-body">
                                        <h6 class="card-title" style="color: #B983FF;">Power Level</h6>
                                        <p class="card-text" id="power-level" style="color: #F3F0FF;">-</p>
                                        <p class="card-text"><small id="total-cost" style="color: #B983FF;">-</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recommendations Tabs -->
                        <ul class="nav nav-tabs" id="recommendations-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="main-deck-tab" data-bs-toggle="tab" data-bs-target="#main-deck" type="button" role="tab">
                                    Main Deck
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="mana-base-tab" data-bs-toggle="tab" data-bs-target="#mana-base" type="button" role="tab">
                                    Mana Base
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="recommendations-tab-content">
                            <div class="tab-pane fade show active" id="main-deck" role="tabpanel">
                                <div id="main-deck-recommendations">
                                    <!-- Main deck recommendations will appear here -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="mana-base" role="tabpanel">
                                <div id="mana-base-recommendations">
                                    <!-- Mana base recommendations will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loading-recommendations" style="display: none; text-align: center; padding: 4rem;">
                        <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
                        <p style="color: #B983FF; margin-top: 1rem;">Analyzing thousands of cards to find the perfect recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Card Versions Modal -->
    <div class="modal fade" id="cardVersionsModal" tabindex="-1" aria-labelledby="cardVersionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="background: #1A0B2E; border: 1px solid rgba(185, 131, 255, 0.3);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(185, 131, 255, 0.3);">
                    <h5 class="modal-title" id="cardVersionsModalLabel" style="color: #B983FF;">Card Versions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="card-versions-content">
                        <!-- Card versions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script>
        let selectedCommander = null;
        let searchTimeout = null;

        // Commander search functionality
        document.getElementById('commander-search-input').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('commander-results').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                searchCommanders(query);
            }, 300);
        });

        async function searchCommanders(query) {
            try {
                const response = await fetch(`/api/commanders/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                displayCommanderResults(data.commanders || []);
            } catch (error) {
                console.error('Error searching commanders:', error);
            }
        }

        // Store commander data for selection
        let commandersData = [];

        function displayCommanderResults(commanders) {
            const resultsDiv = document.getElementById('commander-results');
            
            if (commanders.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #888;">No commanders found</p>';
                return;
            }
            
            // Store commanders data for later access
            commandersData = commanders;
            
            resultsDiv.innerHTML = commanders.map((commander, index) => {
                const colors = commander.colors || [];
                const colorSymbols = colors.map(color => 
                    `<span class="mana-symbol mana-${color}">${color}</span>`
                ).join('');
                
                const manaCost = formatManaCost(commander.mana_cost || '');
                
                return `
                    <div class="commander-card" onclick="selectCommander('${commander.name}', ${index})">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <strong>${commander.name}</strong>
                                <div class="color-identity">${colorSymbols}</div>
                                <small style="color: #888;">${commander.type_line}</small>
                            </div>
                            <div class="mana-cost-display">
                                ${manaCost}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectCommander(commanderName, commanderIndex) {
            selectedCommander = commanderName;
            
            // Highlight selected commander
            document.querySelectorAll('.commander-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.commander-card').classList.add('selected');
            
            // Show selected commander
            document.getElementById('selected-commander').style.display = 'block';
            document.getElementById('commander-display').innerHTML = `<strong>${commanderName}</strong>`;
            
            // Get commander data and display image immediately if available
            const commanderData = commandersData[commanderIndex];
            if (commanderData && commanderData.image_uris && commanderData.image_uris.normal) {
                const imageElement = document.getElementById('commander-image');
                imageElement.src = commanderData.image_uris.normal;
                imageElement.style.display = 'block';
                document.getElementById('commander-image-loading').style.display = 'none';
            } else {
                // Show loading and fetch additional details
                document.getElementById('commander-image-loading').style.display = 'block';
                document.getElementById('commander-image').style.display = 'none';
            }
            
            // Load commander printings (this will also handle cases where we need more image data)
            loadCommanderDetails(commanderName);
            
            // Show filters
            document.getElementById('recommendation-filters').style.display = 'block';
        }

        async function loadCommanderDetails(commanderName) {
            try {
                const response = await fetch(`/api/commanders/${encodeURIComponent(commanderName)}/printings`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display commander image only if we don't already have one showing
                const commander = data.commander;
                const imageElement = document.getElementById('commander-image');
                
                if (!imageElement.src || imageElement.style.display === 'none') {
                    if (commander && commander.image_uris && commander.image_uris.normal) {
                        imageElement.src = commander.image_uris.normal;
                        imageElement.style.display = 'block';
                        document.getElementById('commander-image-loading').style.display = 'none';
                    } else {
                        // Try to find an image from printings
                        const printingWithImage = data.printings.find(p => p.image_uris && p.image_uris.normal);
                        if (printingWithImage) {
                            imageElement.src = printingWithImage.image_uris.normal;
                            imageElement.style.display = 'block';
                            document.getElementById('commander-image-loading').style.display = 'none';
                        } else {
                            document.getElementById('commander-image-loading').innerHTML = 'No image available';
                        }
                    }
                }
                
                // Display printings
                displayCommanderPrintings(data.printings, data.total_versions, commander);
                
            } catch (error) {
                console.error('Error loading commander details:', error);
                document.getElementById('commander-image-loading').innerHTML = 'Error loading image';
                document.getElementById('printings-count').innerHTML = 'Error loading printings';
            }
        }

        function displayCommanderPrintings(printings, totalVersions, currentCommander) {
            const printingsContainer = document.getElementById('commander-printings');
            const printingsCount = document.getElementById('printings-count');
            
            printingsCount.textContent = `${totalVersions} version${totalVersions !== 1 ? 's' : ''}`;
            
            if (!printings || printings.length === 0) {
                printingsContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">No printings found</p>';
                return;
            }
            
            printingsContainer.innerHTML = printings.map((printing, index) => {
                const isActive = currentCommander && currentCommander._id === printing._id;
                const price = printing.prices && printing.prices.usd ? `$${parseFloat(printing.prices.usd).toFixed(2)}` : 'N/A';
                
                // Handle image URL safely like in visualizations.js
                const imageUrl = (printing.image_uris && printing.image_uris.normal) ? printing.image_uris.normal : '';
                
                return `
                    <div class="printing-item ${isActive ? 'active' : ''}" 
                         onclick="switchCommanderImage('${printing.name}', '${imageUrl}', ${index})">
                        <div class="d-flex align-items-center flex-grow-1">
                            <!-- Small thumbnail -->
                            <div class="printing-thumbnail me-2" style="width: 32px; height: 45px; flex-shrink: 0;">
                                ${imageUrl ? `
                                    <img src="${imageUrl}" 
                                         alt="${printing.name}" 
                                         style="width: 32px; height: 45px; border-radius: 4px; object-fit: cover; border: 1px solid rgba(185,131,255,0.3);"
                                         onerror="this.style.display='none';">
                                ` : `
                                    <div style="width: 32px; height: 45px; border-radius: 4px; background: rgba(185,131,255,0.1); border: 1px dashed rgba(185,131,255,0.3); display: flex; align-items: center; justify-content: center; color: #888; font-size: 8px;">
                                        ?
                                    </div>
                                `}
                            </div>
                            
                            <!-- Printing info -->
                            <div class="printing-info flex-grow-1">
                                <div class="printing-set">${printing.set_name || printing.set || 'Unknown Set'}</div>
                                <div class="printing-details">
                                    ${(printing.set || 'UNK').toUpperCase()} • ${printing.collector_number || '?'} • ${printing.rarity || 'Unknown'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Price -->
                        <div class="printing-price ms-2">${price}</div>
                    </div>
                `;
            }).join('');
        }

        function switchCommanderImage(commanderName, imageUrl, printingIndex) {
            const imageElement = document.getElementById('commander-image');
            
            if (imageUrl) {
                imageElement.src = imageUrl;
                
                // Update active printing highlight
                document.querySelectorAll('.printing-item').forEach((item, index) => {
                    if (index === printingIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // Get recommendations
        document.getElementById('get-recommendations-btn').addEventListener('click', async function() {
            if (!selectedCommander) return;
            
            const budget = document.getElementById('budget-select').value;
            const powerLevel = document.getElementById('power-select').value;
            const preferredMechanics = document.getElementById('preferred-mechanics').value.trim();
            
            // Show loading
            document.getElementById('loading-recommendations').style.display = 'block';
            document.getElementById('recommendations-panel').style.display = 'none';
            
            try {
                // Get main recommendations
                const params = new URLSearchParams({
                    commander_name: selectedCommander,
                    power_level: powerLevel
                });
                
                if (budget) {
                    params.append('budget', budget);
                }
                
                if (preferredMechanics) {
                    params.append('preferred_mechanics', preferredMechanics);
                }
                
                const response = await fetch(`/api/commanders/${encodeURIComponent(selectedCommander)}/recommendations?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRecommendations(data);
                
                // Try to get AI analysis
                try {
                    const aiResponse = await fetch(`/api/commanders/${encodeURIComponent(selectedCommander)}/ai-analysis?commander_name=${encodeURIComponent(selectedCommander)}`);
                    const aiData = await aiResponse.json();
                    
                    if (aiData.success) {
                        displayAIAnalysis(aiData.analysis);
                    }
                } catch (aiError) {
                    console.warn('AI analysis not available:', aiError);
                }
                
            } catch (error) {
                console.error('Error getting recommendations:', error);
                alert('Error getting recommendations: ' + error.message);
            } finally {
                document.getElementById('loading-recommendations').style.display = 'none';
            }
        });

        function displayRecommendations(data) {
            // Show recommendations panel
            document.getElementById('recommendations-panel').style.display = 'block';
            
            // Update summary
            document.getElementById('deck-strategy').textContent = data.strategy || 'Strategy analysis in progress...';
            document.getElementById('power-level').textContent = data.power_level || 'Analyzing power level...';
            document.getElementById('total-cost').textContent = data.total_cost ? `Est. Cost: $${data.total_cost.toFixed(2)}` : '';
            
            // Sort recommendations to prioritize AI picks
            const sortedRecommendations = [...data.recommendations].sort((a, b) => {
                // AI suggested cards first
                if (a.ai_suggested && !b.ai_suggested) return -1;
                if (!a.ai_suggested && b.ai_suggested) return 1;
                // Then by confidence
                return b.confidence - a.confidence;
            });
            
            // Display main deck recommendations
            const mainDeckDiv = document.getElementById('main-deck-recommendations');
            mainDeckDiv.innerHTML = sortedRecommendations.map(rec => {
                const confidencePercent = (rec.confidence * 100).toFixed(0);
                const hasMultipleVersions = rec.all_versions && rec.all_versions.length > 1;
                
                // Use the same image pattern as visualizations.js
                let primaryImage = '';
                
                if (rec.primary_version && rec.primary_version.image_uris && rec.primary_version.image_uris.normal) {
                    primaryImage = rec.primary_version.image_uris.normal;
                } else if (rec.image_uris && rec.image_uris.normal) {
                    // Fallback to direct image_uris on rec object
                    primaryImage = rec.image_uris.normal;
                }
                
                return `
                    <div class="recommendation-card ${hasMultipleVersions ? 'clickable-card' : ''}" 
                         style="${rec.ai_suggested ? 'border: 2px solid rgba(78,205,196,0.4); box-shadow: 0 0 15px rgba(78,205,196,0.2);' : ''} ${hasMultipleVersions ? 'cursor: pointer;' : ''}"
                         ${hasMultipleVersions ? `onclick="showCardVersions('${rec.name.replace(/'/g, "\\'")}', ${JSON.stringify(rec.all_versions).replace(/"/g, '&quot;')})"` : ''}>
                        <div class="d-flex align-items-start">
                            <div class="card-image-container me-3" style="position: relative; width: 80px; height: 112px;">
                                ${primaryImage ? `
                                    <img src="${primaryImage}" 
                                         alt="${rec.name}" 
                                         class="card-image-display"
                                         style="width: 80px; height: 112px; border-radius: 8px; object-fit: cover; border: 2px solid rgba(185,131,255,0.3); box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s ease; cursor: pointer;"
                                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(185,131,255,0.4)';"
                                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)';"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'no-image-placeholder\\' style=\\'width: 80px; height: 112px; border-radius: 8px; background: rgba(185,131,255,0.1); display: flex; align-items: center; justify-content: center; color: #888; font-size: 12px; text-align: center; border: 2px dashed rgba(185,131,255,0.3);\\'>No Image<br>Available</div>';">
                                ` : `
                                    <div class="no-image-placeholder" 
                                         style="width: 80px; height: 112px; border-radius: 8px; background: ${rec.ai_suggested ? 'linear-gradient(135deg, rgba(78,205,196,0.1), rgba(185,131,255,0.1))' : 'rgba(185,131,255,0.1)'}; display: flex; align-items: center; justify-content: center; position: relative; border: 2px dashed ${rec.ai_suggested ? 'rgba(78,205,196,0.3)' : 'rgba(185,131,255,0.3)'}; ${rec.ai_suggested ? 'animation: aiGlow 3s infinite;' : ''}">
                                        <div style="text-align: center; color: ${rec.ai_suggested ? '#4ECDC4' : '#888'};">
                                            <div style="font-size: 14px; margin-bottom: 4px;">${rec.ai_suggested ? 'AI' : '?'}</div>
                                            <div style="font-size: 10px; font-weight: bold;">${rec.ai_suggested ? 'PICK' : 'NO IMG'}</div>
                                        </div>
                                    </div>
                                `}
                                ${rec.ai_suggested ? `
                                    <div class="ai-badge" style="position: absolute; top: -8px; right: -8px; background: linear-gradient(45deg, #FF6B6B, #4ECDC4); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 2px solid #fff; font-size: 10px; font-weight: bold;">
                                        AI
                                    </div>
                                ` : ''}
                                ${hasMultipleVersions ? `
                                    <div class="versions-indicator" style="position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); background: rgba(255,165,0,0.9); color: #000; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; box-shadow: 0 1px 4px rgba(0,0,0,0.3);">
                                        ${rec.all_versions.length} Prints
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <strong style="color: #F3F0FF; font-size: 1.1rem;">${rec.name}</strong>
                                            ${rec.ai_suggested ? '<span class="ai-enhanced-badge" style="color: #4ECDC4; font-size: 14px; animation: pulse 2s infinite;">✨ AI</span>' : ''}
                                        </div>
                                        <div class="card-badges mb-2">
                                            <span class="category-badge">${rec.category}</span>
                                            ${hasMultipleVersions ? '<span class="versions-badge">Click for All Prints</span>' : ''}
                                        </div>
                                        <div class="card-details mb-2" style="font-size: 0.9rem; color: #B983FF;">
                                            <div>${rec.primary_version?.set_name || 'Unknown Set'} (${(rec.primary_version?.set || '???').toUpperCase()})</div>
                                            ${rec.estimated_price ? `<div>$${rec.estimated_price.toFixed(2)}</div>` : ''}
                                        </div>
                                        <div class="card-reasons" style="font-size: 0.85rem; color: #CCC; margin-bottom: 8px; line-height: 1.3;">
                                            ${rec.reasons.slice(0, 2).join(' • ')}
                                        </div>
                                        <div class="confidence-section">
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                                            </div>
                                            <div class="confidence-text" style="font-size: 0.8rem; color: #B983FF; margin-top: 2px;">
                                                Confidence: ${confidencePercent}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Display mana base
            const manaBaseDiv = document.getElementById('mana-base-recommendations');
            manaBaseDiv.innerHTML = data.mana_base.map(rec => {
                const hasMultipleVersions = rec.all_versions && rec.all_versions.length > 1;
                const imageUris = rec.primary_version?.image_uris || rec.primary_version?.imageUris;
                const primaryImage = imageUris?.normal || imageUris?.large || imageUris?.small || '';
                
                return `
                    <div class="recommendation-card" ${hasMultipleVersions ? `onclick="showCardVersions('${rec.name}', ${JSON.stringify(rec.all_versions).replace(/"/g, '&quot;')})"` : ''}>
                        <div class="d-flex align-items-center">
                            ${primaryImage ? `
                                <div class="card-image-small me-2">
                                    <img src="${primaryImage}" alt="${rec.name}" style="width: 40px; height: 56px; border-radius: 4px; object-fit: cover;" onerror="this.style.display='none'">
                                </div>
                            ` : ''}
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: #F3F0FF;">${rec.name}</strong>
                                        <span class="category-badge">${rec.category}</span>
                                        ${hasMultipleVersions ? '<span class="versions-badge" style="font-size: 0.7rem;">V</span>' : ''}
                                    </div>
                                    ${rec.estimated_price ? `<small style="color: #B983FF;">$${rec.estimated_price.toFixed(2)}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayAIAnalysis(analysis) {
            document.getElementById('ai-analysis-section').style.display = 'block';
            document.getElementById('ai-analysis-content').innerHTML = 
                `<div style="white-space: pre-wrap; color: #F3F0FF;">${analysis}</div>`;
        }

        function showCardVersions(cardName, allVersions) {
            document.getElementById('cardVersionsModalLabel').textContent = `${cardName} - All Printings`;
            
            const versionsContent = document.getElementById('card-versions-content');
            
            // Parse allVersions if it's a string
            let versions = Array.isArray(allVersions) ? allVersions : JSON.parse(allVersions);
            
            // Sort versions by release date (newest first)
            const sortedVersions = [...versions].sort((a, b) => {
                const dateA = new Date(a.released_at || '2000-01-01');
                const dateB = new Date(b.released_at || '2000-01-01');
                return dateB - dateA;
            });
            
            versionsContent.innerHTML = `
                <div class="mb-3" style="color: #B983FF;">
                    <strong>${sortedVersions.length} printings found</strong> - Click any image to view full size
                </div>
                <div class="row">
                    ${sortedVersions.map((version, index) => {
                        // Handle both direct image_uris and nested structure  
                        const imageUris = version.image_uris || {};
                        const imageUrl = imageUris.normal || imageUris.large || imageUris.small || '';
                        const largeImageUrl = imageUris.large || imageUris.normal || imageUrl;
                        const releaseYear = version.released_at ? new Date(version.released_at).getFullYear() : 'Unknown';
                        
                        return `
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-6 mb-4">
                                <div class="card version-card" style="background: rgba(45, 27, 74, 0.8); border: 1px solid rgba(185, 131, 255, 0.2); transition: all 0.3s ease; cursor: pointer; height: 100%;"
                                     onmouseover="this.style.borderColor='rgba(185,131,255,0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(185,131,255,0.2)';"
                                     onmouseout="this.style.borderColor='rgba(185,131,255,0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                                     onclick="showLargeCardImage('${cardName.replace(/'/g, "\\'")}', '${largeImageUrl}', ${JSON.stringify(version).replace(/"/g, '&quot;')})">
                                    ${imageUrl ? `
                                        <div class="image-container" style="position: relative; height: 200px; overflow: hidden; border-radius: 6px 6px 0 0;">
                                            <img src="${imageUrl}" class="card-img-top" alt="${cardName}" 
                                                 style="height: 200px; width: 100%; object-fit: contain; transition: transform 0.3s ease;"
                                                 onmouseover="this.style.transform='scale(1.05)';"
                                                 onmouseout="this.style.transform='scale(1)';">
                                            <div class="image-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.7)); opacity: 0; transition: opacity 0.3s ease;"
                                                 onmouseover="this.style.opacity='1';"
                                                 onmouseout="this.style.opacity='0';">
                                                <div style="position: absolute; bottom: 8px; left: 8px; color: white; font-size: 12px; font-weight: bold;">
                                                    Click to enlarge
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="card-img-top d-flex align-items-center justify-content-center" 
                                             style="height: 200px; background: rgba(0,0,0,0.3); color: #888; border-radius: 6px 6px 0 0;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 24px; margin-bottom: 4px;">🖼️</div>
                                                <div style="font-size: 12px;">No Image</div>
                                            </div>
                                        </div>
                                    `}
                                    <div class="card-body p-2" style="flex-grow: 1; display: flex; flex-direction: column;">
                                        <h6 class="card-title" style="color: #F3F0FF; font-size: 0.85rem; margin-bottom: 8px; line-height: 1.2; flex-shrink: 0;">
                                            ${version.set_name || 'Unknown Set'}
                                        </h6>
                                        <div class="card-details" style="font-size: 0.75rem; color: #B983FF; flex-grow: 1;">
                                            <div class="mb-1">
                                                <strong>${(version.set || 'UNK').toUpperCase()}</strong> 
                                                #${version.collector_number || '?'}
                                            </div>
                                            <div class="mb-2 d-flex align-items-center justify-content-between">
                                                <span class="rarity-badge" style="background: ${getRarityColor(version.rarity)}; color: #000; padding: 1px 4px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">
                                                    ${(version.rarity || 'common').toUpperCase()}
                                                </span>
                                                <span style="color: #FFA500; font-size: 0.7rem;">
                                                    ${releaseYear}
                                                </span>
                                            </div>
                                            ${version.price && version.price > 0 ? `
                                                <div class="price-display" style="color: #00FF88; font-weight: bold; font-size: 0.8rem; text-align: center; background: rgba(0,255,136,0.1); padding: 2px 4px; border-radius: 4px;">
                                                    $${version.price.toFixed(2)}
                                                </div>
                                            ` : `
                                                <div style="color: #666; font-size: 0.7rem; text-align: center; font-style: italic;">
                                                    Price N/A
                                                </div>
                                            `}
                                            ${version.artist ? `
                                                <div style="color: #888; font-size: 0.7rem; margin-top: 4px; text-align: center; font-style: italic;">
                                                    by ${version.artist}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('cardVersionsModal'));
            modal.show();
        }

        // New function to show large card image (similar to visualizations tab)
        function showLargeCardImage(cardName, imageUrl, versionData) {
            if (!imageUrl) return;
            
            const version = typeof versionData === 'string' ? JSON.parse(versionData) : versionData;
            const priceDisplay = version.price && version.price > 0 ? `$${version.price.toFixed(2)}` : 'Price N/A';
            
            const largeImageModal = `
                <div class="modal fade" id="largeCardImageModal" tabindex="-1" style="z-index: 1070;">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content" style="background: #1A0B2E; border: 1px solid rgba(185, 131, 255, 0.3);">
                            <div class="modal-header" style="border-bottom: 1px solid rgba(185, 131, 255, 0.3);">
                                <h5 class="modal-title" style="color: #B983FF;">${cardName} - ${version.set_name || 'Unknown Set'}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center" style="padding: 1rem;">
                                <div class="image-container mb-3">
                                    <img src="${imageUrl}" alt="${cardName}" 
                                         style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);"
                                         onclick="window.open('${imageUrl}', '_blank')">
                                </div>
                                <div class="card-info" style="background: rgba(45, 27, 74, 0.6); padding: 1rem; border-radius: 8px; border: 1px solid rgba(185, 131, 255, 0.2);">
                                    <div class="row text-start">
                                        <div class="col-md-6">
                                            <div class="info-item mb-2">
                                                <strong style="color: #B983FF;">Set:</strong>
                                                <span style="color: #F3F0FF;">${version.set_name || 'Unknown'}</span>
                                            </div>
                                            <div class="info-item mb-2">
                                                <strong style="color: #B983FF;">Code:</strong>
                                                <span style="color: #F3F0FF;">${(version.set || 'UNK').toUpperCase()} #${version.collector_number || '?'}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item mb-2">
                                                <strong style="color: #B983FF;">Rarity:</strong>
                                                <span class="rarity-badge ms-1" style="background: ${getRarityColor(version.rarity)}; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
                                                    ${(version.rarity || 'common').toUpperCase()}
                                                </span>
                                            </div>
                                            <div class="info-item mb-2">
                                                <strong style="color: #B983FF;">Price:</strong>
                                                <span style="color: #00FF88; font-weight: bold;">${priceDisplay}</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${version.artist ? `
                                        <div class="artist-info mt-2 pt-2" style="border-top: 1px solid rgba(185, 131, 255, 0.2);">
                                            <strong style="color: #B983FF;">Artist:</strong>
                                            <span style="color: #F3F0FF; font-style: italic;">${version.artist}</span>
                                        </div>
                                    ` : ''}
                                    <div class="mt-3">
                                        <button class="btn btn-sm" style="background: rgba(185,131,255,0.2); border-color: #B983FF; color: #B983FF;"
                                                onclick="window.open('${imageUrl}', '_blank')">
                                            Open Full Size in New Tab
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing large image modal
            const existingModal = document.getElementById('largeCardImageModal');
            if (existingModal) existingModal.remove();
            
            // Add and show modal
            document.body.insertAdjacentHTML('beforeend', largeImageModal);
            const modal = new bootstrap.Modal(document.getElementById('largeCardImageModal'));
            modal.show();
        }

        function formatManaCost(manaCost) {
            if (!manaCost) return '';
            
            // Parse mana cost like "{3}{W}{U}{B}" into individual symbols
            const symbols = manaCost.match(/{[^}]+}/g) || [];
            
            return symbols.map(symbol => {
                const cleanSymbol = symbol.replace(/{|}/g, '');
                
                // Check if it's a number (generic mana)
                if (/^\d+$/.test(cleanSymbol)) {
                    return `<span class="mana-symbol mana-generic">${cleanSymbol}</span>`;
                }
                
                // Color symbols
                return `<span class="mana-symbol mana-${cleanSymbol.toLowerCase()}">${cleanSymbol}</span>`;
            }).join('');
        }

        function getRarityColor(rarity) {
            const colors = {
                'mythic': '#FF8C00',
                'rare': '#FFD700', 
                'uncommon': '#C0C0C0',
                'common': '#808080'
            };
            return colors[rarity] || colors.common;
        }

        async function generateAnalysisSummary() {
            if (!selectedCommander) return;
            
            // Show loading state
            document.getElementById('analysis-summary').style.display = 'block';
            document.getElementById('analysis-summary-content').innerHTML = 
                '<div class="loading-spinner"></div> Analyzing all data to generate executive summary...';
            
            // Disable the button
            const btn = document.getElementById('generate-summary-btn');
            btn.disabled = true;
            btn.innerHTML = 'Generating...';
            
            try {
                // Get current analysis data
                const aiContent = document.getElementById('ai-analysis-content').textContent;
                
                // Generate summary via new API endpoint
                const response = await fetch(`/api/commanders/${encodeURIComponent(selectedCommander)}/analysis-summary`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        commander_name: selectedCommander,
                        existing_analysis: aiContent,
                        recommendations_data: {
                            // Include key metrics for summary
                            total_recommendations: document.querySelectorAll('.recommendation-card').length,
                            strategy: document.getElementById('deck-strategy').textContent,
                            power_level: document.getElementById('power-level').textContent
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('analysis-summary-content').innerHTML = 
                        `<div style="white-space: pre-wrap; color: #F3F0FF;">${data.summary}</div>`;
                } else {
                    throw new Error(data.error || 'Failed to generate summary');
                }
                
            } catch (error) {
                console.error('Error generating summary:', error);
                document.getElementById('analysis-summary-content').innerHTML = 
                    `<div style="color: #FF6B6B;">Failed to generate summary: ${error.message}</div>`;
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'Regenerate Summary';
            }
        }

        // Theme selection functions
        function addTheme(theme) {
            const mechanicsTextarea = document.getElementById('preferred-mechanics');
            const currentText = mechanicsTextarea.value.trim();
            
            if (currentText === '') {
                mechanicsTextarea.value = theme;
            } else {
                // Add with comma separator if not already present
                if (!currentText.toLowerCase().includes(theme.toLowerCase())) {
                    mechanicsTextarea.value = currentText + ', ' + theme;
                }
            }
            
            // Add visual feedback
            mechanicsTextarea.focus();
        }

        // Export functions
        function exportToScryfall() {
            if (!selectedCommander) return;
            
            // Get current recommendations from the main deck container
            const recommendationCards = document.querySelectorAll('#main-deck-recommendations .recommendation-card');
            if (recommendationCards.length === 0) {
                alert('No recommendations to export. Please generate recommendations first.');
                return;
            }
            
            // Build deck list in Scryfall format
            let deckList = `# ${selectedCommander} - AI Enhanced Commander Deck\n`;
            deckList += `# Generated by MTG EcoRec on ${new Date().toLocaleDateString()}\n\n`;
            deckList += `1 ${selectedCommander} *CMDR*\n\n`;
            
            // Add main deck cards
            recommendationCards.forEach((card, index) => {
                const cardName = card.querySelector('strong').textContent.trim();
                const isAIPick = card.style.border && card.style.border.includes('78,205,196');
                deckList += `1 ${cardName}${isAIPick ? ' # AI Recommended' : ''}\n`;
            });
            
            // Add basic lands based on commander's colors (if we can detect them)
            deckList += `\n# Basic Lands (adjust quantities based on your commander's colors)\n`;
            
            // Try to get commander colors from the selected commander data
            const commanderData = commandersData.find(c => c.name === selectedCommander);
            if (commanderData && commanderData.colors) {
                const colorToLand = { 'W': 'Plains', 'U': 'Island', 'B': 'Swamp', 'R': 'Mountain', 'G': 'Forest' };
                const commanderColors = commanderData.colors;
                const landsPerColor = Math.floor(35 / commanderColors.length); // Rough estimate for 35-land manabase
                
                commanderColors.forEach(color => {
                    if (colorToLand[color]) {
                        deckList += `${landsPerColor} ${colorToLand[color]}\n`;
                    }
                });
            } else {
                // Fallback for all basic lands
                deckList += `7 Plains\n7 Island\n7 Swamp\n7 Mountain\n7 Forest\n`;
            }
            
            // Create and download file
            const blob = new Blob([deckList], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedCommander.replace(/[^a-zA-Z0-9]/g, '_')}_deck.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Also copy to clipboard
            navigator.clipboard.writeText(deckList).then(() => {
                alert('Deck list copied to clipboard and downloaded! You can paste this into Scryfall\'s deck builder.');
            }).catch(() => {
                alert('Deck list downloaded! You can upload the file to Scryfall\'s deck builder.');
            });
        }

        function exportToText() {
            if (!selectedCommander) return;
            
            // Get current recommendations from the main deck container
            const recommendationCards = document.querySelectorAll('#main-deck-recommendations .recommendation-card');
            if (recommendationCards.length === 0) {
                alert('No recommendations to export. Please generate recommendations first.');
                return;
            }
            
            // Build simple text list
            let textList = `${selectedCommander} - Commander Deck Recommendations\n`;
            textList += `Generated: ${new Date().toLocaleString()}\n`;
            textList += `=`.repeat(50) + '\n\n';
            
            textList += `COMMANDER:\n${selectedCommander}\n\n`;
            
            // Separate AI and regular recommendations
            const aiRecommendations = [];
            const regularRecommendations = [];
            
            recommendationCards.forEach((card) => {
                const cardName = card.querySelector('strong').textContent.trim();
                const category = card.querySelector('.category-badge')?.textContent.trim() || 'Unknown';
                
                // Look for confidence percentage in various places
                const confidenceElements = card.querySelectorAll('*');
                let confidence = 'N/A';
                for (let el of confidenceElements) {
                    if (el.textContent && el.textContent.includes('%')) {
                        confidence = el.textContent.trim();
                        break;
                    }
                }
                
                const isAIPick = card.style.border && card.style.border.includes('78,205,196');
                
                const cardInfo = `${cardName} (${category}) - ${confidence}`;
                
                if (isAIPick) {
                    aiRecommendations.push(cardInfo);
                } else {
                    regularRecommendations.push(cardInfo);
                }
            });
            
            if (aiRecommendations.length > 0) {
                textList += `AI RECOMMENDED CARDS (${aiRecommendations.length}):\n`;
                aiRecommendations.forEach((card, index) => {
                    textList += `${index + 1}. ${card}\n`;
                });
                textList += '\n';
            }
            
            if (regularRecommendations.length > 0) {
                textList += `OTHER RECOMMENDATIONS (${regularRecommendations.length}):\n`;
                regularRecommendations.forEach((card, index) => {
                    textList += `${index + 1}. ${card}\n`;
                });
                textList += '\n';
            }
            
            textList += `\nTotal Recommendations: ${recommendationCards.length}\n`;
            textList += `AI Enhanced: ${aiRecommendations.length} cards\n`;
            
            // Create and download file
            const blob = new Blob([textList], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedCommander.replace(/[^a-zA-Z0-9]/g, '_')}_recommendations.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Also copy to clipboard
            navigator.clipboard.writeText(textList).then(() => {
                alert('Recommendation list copied to clipboard and downloaded!');
            }).catch(() => {
                alert('Recommendation list downloaded!');
            });
        }
    </script>
</body>
</html>