<!doctype html>
<head>
    <title>Hello Azure - Python Quickstart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<html>
   <body>
   <main>
    <div class="px-4 py-3 my-2 text-center">
      <img class="d-block mx-auto mb-4" src="{{ url_for('static', filename='images/azure-icon.svg') }}" alt="Azure Logo" width="192" height="192"/>
      <h1 class="display-6 fw-bold text-primary">Welcome to Azure</h1>
    </div>

    <div class="container my-4">
      <h2 class="mb-3">Card Database</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" id="cards-table">
          <thead class="table-dark">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Set</th>
              <th>Rarity</th>
              <th>Price</th>
              <th>Image</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination will be inserted here -->
        </ul>
      </nav>
    </div>
   </main>
   <script>
    const PAGE_SIZE = 10;
    let cards = [];
    let currentPage = 1;

    function renderTable(page) {
      const tbody = document.querySelector('#cards-table tbody');
      tbody.innerHTML = '';
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageCards = cards.slice(start, end);
      for (const card of pageCards) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${card.name || ''}</td>
          <td>${card.type || ''}</td>
          <td>${card.set || ''}</td>
          <td>${card.rarity || ''}</td>
          <td>${card.price !== undefined ? '$' + card.price.toLocaleString() : ''}</td>
          <td>${card.image_url ? `<img src="${card.image_url}" alt="${card.name}" style="max-width:60px;max-height:80px;cursor:pointer;" onclick="showCardModal(${start + pageCards.indexOf(card)})">` : ''}</td>
        </tr>`;
        tbody.appendChild(row);
      }

    }
   </script>

   <!-- Modal for card image popout -->
   <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered modal-lg">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title" id="cardModalLabel">Card Details</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body text-center">
           <img id="modalCardImage" src="" alt="Card Image" style="max-width:100%;max-height:60vh;">
           <div class="mt-3" id="modalCardCaption"></div>
         </div>
       </div>
     </div>
   </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function showCardModal(cardIndex) {
      const card = cards[cardIndex];
      document.getElementById('modalCardImage').src = card.image_url;
      document.getElementById('modalCardImage').alt = card.name;
      // Compose caption with core info
      document.getElementById('modalCardCaption').innerHTML = `
        <strong>${card.name || ''}</strong><br>
        <span>${card.type || ''}</span><br>
        <span>Set: ${card.set || ''}</span><br>
        <span>Rarity: ${card.rarity || ''}</span><br>
        <span>Price: ${card.price !== undefined ? '$' + card.price.toLocaleString() : ''}</span>
      `;
      var modal = new bootstrap.Modal(document.getElementById('cardModal'));
      modal.show();
    }

    function renderPagination() {
      const pageCount = Math.ceil(cards.length / PAGE_SIZE);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= pageCount; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = i;
        a.onclick = (e) => {
          e.preventDefault();
          currentPage = i;
          renderTable(currentPage);
          renderPagination();
        };
        li.appendChild(a);
        pagination.appendChild(li);
      }
    }

    async function fetchCards() {
      try {
        const res = await fetch('/api/cards');
        cards = await res.json();
        renderTable(currentPage);
        renderPagination();
      } catch (err) {
        console.error('Failed to fetch cards:', err);
      }
    }

    window.onload = fetchCards;
   </script>
   </body>
</html>